<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Merry Christmas & Santa's Challenge</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Nunito:wght@400;600;700&family=Mountains+of+Christmas:wght@700&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            /* Card Theme */
            --bg-gradient-day: linear-gradient(180deg, #e3f2fd 0%, #ffffff 100%);
            --card-bg: #ffffff;
            --grid-line: rgba(0, 0, 0, 0.05);
            --primary-red: #ef5350;
            --pastel-pink: #ffebee;
            --heart-color: #ff5252;
            --text-dark: #455a64;
            --text-hand: #37474f;
            --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.08);
            --btn-blue: #29b6f6;
            --btn-blue-hover: #039be5;

            /* Game Theme */
            --bg-night: #050b1a;
            --santa-red: #d42426;
            --gold: #ffd700;
            --glass: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            user-select: none; -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-gradient-day);
            height: 100vh; width: 100vw;
            overflow: hidden;
            position: relative;
            transition: background 1s ease-in-out;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        
        /* --- 1. CHRISTMAS CARD STYLES --- */
        
        .snow-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5;
            transition: opacity 1s;
        }

        .snowflake {
            position: absolute; top: -10px; color: #b3e5fc;
            font-size: 1em; opacity: 0.8; animation: fall linear infinite;
        }

        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0) rotate(0deg); }
            100% { transform: translateY(110vh) translateX(20px) rotate(360deg); }
        }

        #app-container {
            width: 100%; max-width: 400px; height: 100%; max-height: 800px;
            position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.8s ease, transform 0.8s ease;
            transform: scale(0.95);
        }

        .screen.active { opacity: 1; pointer-events: all; transform: scale(1); }

        .card-base {
            background-color: var(--card-bg);
            background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 30px 30px;
            width: 90%; aspect-ratio: 1 / 1.1;
            border-radius: 20px; box-shadow: var(--shadow-soft);
            padding: 20px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            position: relative;
        }

        h1, h2 { font-family: 'Dancing Script', cursive; color: var(--text-hand); font-weight: 700; }
        h1 { font-size: 2.8rem; line-height: 1.2; margin-bottom: 10px; }
        h2 { font-size: 2rem; margin-bottom: 15px; }
        p { color: var(--text-dark); font-size: 1.1rem; line-height: 1.6; margin-bottom: 10px; }

        .gift-container, .sleigh-container { cursor: pointer; position: relative; animation: float 3s ease-in-out infinite; }
        .gift-emoji { font-size: 8rem; display: block; }
        .sleigh-emoji { font-size: 7rem; }
        .snowman-img { font-size: 7rem; margin-bottom: 20px; }
        
        .tap-me-bubble, .tap-tag {
            position: absolute; background: white; padding: 8px 15px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: bold; color: var(--primary-red);
            font-size: 0.9rem; animation: bounce 1s infinite;
        }
        .tap-me-bubble { top: -20px; right: -20px; }
        .tap-tag { top: 0; right: -10px; background: var(--primary-red); color: white; }

        .btn-open {
            background: var(--btn-blue); color: white; border: none; padding: 12px 40px;
            border-radius: 30px; font-size: 1.2rem; font-weight: 600; margin-top: 25px;
            cursor: pointer; box-shadow: 0 4px 15px rgba(41, 182, 246, 0.4);
            transition: transform 0.2s, background 0.3s;
        }
        .btn-open:active { transform: scale(0.95); }
        
        /* Secondary transparent button style */
        .btn-text-only {
            background: transparent; color: #aaa; border: none; padding: 10px;
            font-size: 0.9rem; margin-top: 10px; cursor: pointer;
            text-decoration: underline;
        }

        /* Letter Modal */
        .letter-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.5s; backdrop-filter: blur(4px);
        }
        .letter-modal.visible { opacity: 1; pointer-events: all; }
        .letter-content {
            background: white; width: 85%; padding: 30px; border-radius: 15px;
            text-align: left; transform: translateY(20px); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            /* Scrollable fix for small screens */
            max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column;
        }
        .letter-modal.visible .letter-content { transform: translateY(0); }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; color: #aaa; cursor: pointer; z-index: 10; }

        /* Polaroid Gallery */
        .grid-gallery { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .row { display: flex; justify-content: center; gap: 15px; }
        .flip-card { background-color: transparent; width: 70px; height: 85px; perspective: 1000px; cursor: pointer; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 4px solid white; }
        .flip-card-front { background-color: var(--pastel-pink); }
        .flip-card-back { background-color: var(--pastel-pink); transform: rotateY(180deg); font-family: 'Nunito', sans-serif; font-weight: bold; color: #444; font-size: 0.9rem; }
        .heart-icon { color: var(--heart-color); font-size: 1.5rem; }

        /* --- 2. GAME STYLES --- */
        #game-wrapper {
            position: fixed; inset: 0; z-index: 50;
            opacity: 0; pointer-events: none; transition: opacity 1s ease;
            background: var(--bg-night);
        }
        #game-wrapper.active { opacity: 1; pointer-events: all; }

        canvas { display: block; width: 100%; height: 100%; }

        #ui-layer {
            position: absolute; inset: 0; pointer-events: none; z-index: 100;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .top-bar { padding: 35px; display: flex; justify-content: space-between; align-items: flex-start; }
        .stats-card {
            background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 24px;
            padding: 10px 25px; color: white; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .stats-card h1 { font-family: 'Mountains of Christmas'; font-size: 2.5rem; color: var(--gold); margin: 0; }

        .game-controls { pointer-events: auto; display: flex; gap: 10px; }
        .mini-btn {
            background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4);
            padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; cursor: pointer;
            backdrop-filter: blur(10px); transition: background 0.2s;
            font-family: 'Nunito', sans-serif; font-weight: 700;
        }
        .mini-btn:hover { background: rgba(255,255,255,0.4); }

        #start-overlay, #victory-screen {
            position: absolute; inset: 0; background: rgba(5, 11, 26, 0.9);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 2000; display: flex; justify-content: center; align-items: center;
            flex-direction: column; pointer-events: auto;
        }
        #victory-screen { display: none; background: rgba(212, 36, 38, 0.9); }

        .guide-modal {
            background: #fdf5e6; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;
            text-align: center; color: #2c1810; border: 8px double var(--santa-red);
            font-family: 'Mountains of Christmas'; box-shadow: 0 0 50px rgba(0,0,0,0.5);
            animation: float 3s ease-in-out infinite;
        }
        .guide-modal h2 { color: var(--santa-red); font-size: 2.5rem; margin: 0 0 15px 0; }
        .guide-modal p { font-family: 'Quicksand'; font-weight: 700; font-size: 1.1rem; margin-bottom: 10px; }
        
        .game-btn {
            background: var(--santa-red); color: white; border: none; padding: 15px 30px;
            font-size: 1.5rem; border-radius: 50px; cursor: pointer; margin-top: 15px;
            font-family: 'Mountains of Christmas'; border: 2px solid white;
            box-shadow: 0 10px 20px rgba(212, 36, 38, 0.4); transition: transform 0.2s;
        }
        .game-btn:active { transform: scale(0.95); }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .music-control {
            position: absolute; top: 20px; right: 20px; z-index: 200;
            background: white; width: 40px; height: 40px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 1.2rem; transition: all 0.3s;
        }
        .music-control.playing { animation: spin 4s linear infinite; background: #e3f2fd; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="snow-container" id="card-snow"></div>
    <div class="music-control" id="music-btn" onclick="toggleMusic()">üéµ</div>

    <div id="app-container">
        <div class="screen active" id="screen-1">
            <h1 style="margin-bottom: 40px;">For someone special</h1>
            <div class="gift-container" onclick="nextScreen(1)">
                <span class="gift-emoji">üéÅ</span>
                <div class="tap-me-bubble">Tap me!</div>
            </div>
            <button class="btn-open" style="margin-top: 40px;" onclick="nextScreen(1)">Begin ‚û°Ô∏è</button>
        </div>

        <div class="screen" id="screen-2">
            <div class="card-base">
                <div class="snowman-img">‚õÑ</div>
                <h1>This Christmas,</h1>
                <h1 style="font-size: 1.8rem; margin-top:-5px;">something special for you</h1>
                <button class="btn-open" onclick="nextScreen(2)">Open it</button>
            </div>
        </div>

        <div class="screen" id="screen-3">
            <div class="card-base">
                <h1>Merry Christmas</h1>
                <h2 style="font-family: 'Dancing Script'; margin-top: -10px;">to my Cutiepie</h2>
                
                <div class="sleigh-container" onclick="openLetter()">
                    <span class="sleigh-emoji">üéÖüõ∑</span>
                    <div class="tap-tag">Tap to read</div>
                </div>
                <button class="btn-open" style="margin-top: 30px; font-size: 1rem; padding: 10px 30px;" onclick="nextScreen(3)">Next ‚û°Ô∏è</button>
            </div>
        </div>

        <div class="screen" id="screen-4">
            <div class="card-base">
                <h1>Just for you</h1>
                <p style="font-size: 0.9rem; margin-bottom: 20px;">I don't need a gift, because...</p>
                
                <div class="grid-gallery">
                    <div class="row">
                        <div class="flip-card" onclick="flipCard(this)">
                            <div class="flip-card-inner">
                                <div class="flip-card-front"><span class="heart-icon">‚ù§Ô∏è</span></div>
                                <div class="flip-card-back">You</div>
                            </div>
                        </div>
                        <div class="flip-card" onclick="flipCard(this)">
                            <div class="flip-card-inner">
                                <div class="flip-card-front"><span class="heart-icon">‚ù§Ô∏è</span></div>
                                <div class="flip-card-back">are</div>
                            </div>
                        </div>
                        <div class="flip-card" onclick="flipCard(this)">
                            <div class="flip-card-inner">
                                <div class="flip-card-front"><span class="heart-icon">‚ù§Ô∏è</span></div>
                                <div class="flip-card-back">my</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="flip-card" onclick="flipCard(this)">
                            <div class="flip-card-inner">
                                <div class="flip-card-front"><span class="heart-icon">‚ù§Ô∏è</span></div>
                                <div class="flip-card-back">cutest</div>
                            </div>
                        </div>
                        <div class="flip-card" onclick="flipCard(this)">
                            <div class="flip-card-inner">
                                <div class="flip-card-front"><span class="heart-icon">‚ù§Ô∏è</span></div>
                                <div class="flip-card-back">gift üéÅ</div>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn-open" id="to-transition-btn" style="margin-top: 20px; font-size: 1rem; padding: 8px 20px;" onclick="nextScreen(4)">One Last Surprise ‚û°Ô∏è</button>
            </div>
        </div>

        <div class="screen" id="screen-5">
            <div class="card-base" style="background: #fff8e1;">
                <h1 style="color: #d42426;">Santa's Challenge!</h1>
                <p>Can you help Santa deliver 20 gifts?</p>
                <div style="font-size: 4rem; margin: 10px 0;">üéÖüöß</div>
                
                <button class="btn-open" style="background: #d42426; box-shadow: 0 4px 15px rgba(212, 36, 38, 0.4);" onclick="transitionToGame()">üéÆ Play Game</button>
                
                <div style="margin-top: 20px;">
                     <button class="mini-btn" style="background: #ddd; color: #555; border: none;" onclick="replayChristmas()">Replay Story ‚Ü∫</button>
                </div>
            </div>
        </div>
    </div>

    <div class="letter-modal" id="letter-modal">
        <div class="letter-content">
            <div class="close-btn" onclick="closeLetter()">√ó</div>
            
            <div style="font-family: 'Quicksand', sans-serif; color: #5d4037; text-align: left; line-height: 1.7; padding-right: 5px;">
                <h2 style="font-family: 'Dancing Script', cursive; color: #d42426; font-size: 2.2rem; margin-bottom: 20px;">my love üå∑üíñ</h2>
                
                <p style="margin-bottom: 20px;">
                    merry christmas to you ü§≠ i really wish i could be right there with you right now, seeing your smile, hearing your laugh, and just being close to you, christmas feels so much warmer just because you exist, and even with the distance, you make everything feel softer, safer, and calmer for me üíó
                </p>
                
                <p style="margin-bottom: 20px;">
                    you are honestly the best gift i could ever ask for üíñ not because of anything material, but because of the way you care, the effort you put in, and how you make me feel seen and chosen every single day, this year gave me so many moments with you that i will always keep close to my heart üå∑ our late talks, silly laughs, quiet moments, and the way you try for me without even realizing how special that is, you make ordinary days feel meaningful, and having you in my life makes christmas feel truly magical üíó
                </p>

                <p style="margin-bottom: 25px;">
                    i hope this christmas wraps you in warmth, peace, and love üå∑ i hope you feel appreciated, safe, and deeply loved, because that is exactly what you are to me, thank you for being you, for loving me the way you do, and for being my favorite person, always, no matter the distance ü§≠üíñ
                </p>
            </div>
            
            <div style="text-align: center; margin-top: auto; border-top: 1px dashed #eee; padding-top: 20px;">
                <button class="btn-open" style="padding: 10px 30px; font-size: 1rem; margin-top: 0; background: #ff5252;" onclick="closeLetter()">Back to surprises</button>
            </div>
        </div>
    </div>

    <div id="game-wrapper" class="hidden">
        <div id="ui-layer">
            <div class="top-bar">
                <div class="stats-card">
                    <small style="letter-spacing: 3px; opacity: 0.8; font-size: 0.7rem;">SCORE</small>
                    <h1 id="score-val">0</h1>
                </div>
                <div class="game-controls">
                    <button class="mini-btn" onclick="resetGameLogic()">Restart</button>
                    <button class="mini-btn" onclick="exitGame()">Exit</button>
                </div>
            </div>
        </div>

        <div id="start-overlay">
            <div class="guide-modal">
                <h2>Santa's Mission</h2>
                <p>Hold down to grow the stick.</p>
                <p>Release to drop it.</p>
                <p>Walk to the next chimney!</p>
                <p style="color: var(--santa-red); font-weight: 800; border-top: 2px solid rgba(0,0,0,0.1); padding-top: 15px;">GOAL: 20 GIFTS</p>
                <button class="game-btn" id="entry-button">Start üéÅ</button>
            </div>
        </div>

        <div id="victory-screen">
            <div class="guide-modal" style="border-color: var(--gold);">
                <h2 style="color: var(--gold); text-shadow: 2px 2px 0 #000;">Mission Complete!</h2>
                <p>You delivered all 20 gifts!</p>
                <p>Christmas is saved!</p>
                <button class="game-btn" id="restart-button" style="background: var(--gold); color: #8b4513;">Play Again</button>
                <button class="game-btn" onclick="exitGame()" style="background: transparent; color: white; border: none; font-size: 1rem; margin-top: 10px;">Back to Card</button>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <audio id="bg-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-christmas-bells-transition-2987.mp3" type="audio/mpeg">
    </audio>

    <script>
        /* =========================================
           PART 1: CHRISTMAS CARD LOGIC
           ========================================= */
        
        function createCardSnow() {
            const container = document.getElementById('card-snow');
            container.innerHTML = '';
            const particleCount = 30;
            for (let i = 0; i < particleCount; i++) {
                const flake = document.createElement('div');
                flake.classList.add('snowflake');
                flake.innerHTML = '‚ùÑ';
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.animationDuration = Math.random() * 3 + 2 + 's';
                flake.style.fontSize = Math.random() * 10 + 10 + 'px';
                flake.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(flake);
            }
        }

        function nextScreen(currentScreenNum) {
            console.log(`Navigating from Screen ${currentScreenNum}`);
            const current = document.getElementById(`screen-${currentScreenNum}`);
            current.style.opacity = '0';
            current.style.transform = 'scale(0.95)';
            
            setTimeout(() => {
                current.classList.remove('active');
                const next = document.getElementById(`screen-${currentScreenNum + 1}`);
                if(next) {
                    next.classList.add('active');
                    // Force reflow
                    void next.offsetWidth;
setTimeout(() => {
                        next.style.opacity = '1';
                        next.style.transform = 'scale(1)';
                    }, 50);
                }
            }, 800);
        }

        function openLetter() { document.getElementById('letter-modal').classList.add('visible'); }
        function closeLetter() { document.getElementById('letter-modal').classList.remove('visible'); }
        
        // No longer needed, but kept for compatibility just in case
        function closeLetterAndAdvance() {
            closeLetter();
            // Removed auto-advance logic as per request
        }

        let flippedCount = 0;
        function flipCard(cardElement) {
            if (!cardElement.classList.contains('flipped')) {
                cardElement.classList.add('flipped');
                flippedCount++;
                if(flippedCount === 5) {
                    setTimeout(() => {
                        triggerConfetti();
                        // Button is already visible now, but we can animate/highlight it if we wanted
                    }, 500);
                }
            }
        }

        function triggerConfetti() {
            document.body.style.background = "linear-gradient(180deg, #ffebee 0%, #ffffff 100%)";
            createCardSnow(); 
        }

        function replayChristmas() {
            const cards = document.querySelectorAll('.flip-card');
            cards.forEach(c => c.classList.remove('flipped'));
            flippedCount = 0;
            // Button is always visible now
            // document.getElementById('to-transition-btn').classList.add('hidden');
            document.body.style.background = "var(--bg-gradient-day)";

            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
                s.style.opacity = '0';
                s.style.transform = 'scale(0.95)';
            });
            
            const s1 = document.getElementById('screen-1');
            s1.classList.add('active');
            setTimeout(() => {
                s1.style.opacity = '1';
                s1.style.transform = 'scale(1)';
            }, 100);
        }

        let isPlaying = false;
        function toggleMusic() {
            const audio = document.getElementById('bg-music');
            const btn = document.getElementById('music-btn');
            if (isPlaying) {
                audio.pause();
                btn.classList.remove('playing');
                btn.innerHTML = 'üéµ';
                btn.style.opacity = "0.7";
            } else {
                audio.play().catch(e => console.log("Interaction required"));
                btn.classList.add('playing');
                btn.innerHTML = 'üîä';
                btn.style.opacity = "1";
            }
            isPlaying = !isPlaying;
        }

        /* =========================================
           PART 2: GAME ENGINE
           ========================================= */
        
        // Canvas roundRect Polyfill
        if (CanvasRenderingContext2D && !CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r = 0) {
                if (typeof r === 'number') r = { tl: r, tr: r, br: r, bl: r };
                else r = { ...{ tl: 0, tr: 0, br: 0, bl: 0 }, ...r };
                this.beginPath();
                this.moveTo(x + r.tl, y);
                this.lineTo(x + w - r.tr, y);
                this.quadraticCurveTo(x + w, y, x + w, y + r.tr);
                this.lineTo(x + w, y + h - r.br);
                this.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
                this.lineTo(x + r.bl, y + h);
                this.quadraticCurveTo(x, y + h, x, y + h - r.bl);
                this.lineTo(x, y + r.tl);
                this.quadraticCurveTo(x, y, x + r.tl, y);
                this.closePath();
            };
        }

        const GAME_SETTINGS = {
            fixedScale: 0.8,
            platformHeight: 250,
            stickGrowthRate: 6.0,
            santaWalkSpeed: 5.0,
            winScore: 20,
            colors: {
                bgTop: '#050b1a',
                bgBottom: '#1e293b',
                platform1: '#ffffff',
                platform2: '#0ea5e9',
                santa: '#d42426'
            }
        };

        const PI = Math.PI;

        class ParticleFactory {
            constructor(w, h) {
                this.w = w; this.h = h;
                this.particles = [];
                for (let i = 0; i < 100; i++) this.resetParticle({}, true);
            }
            resetParticle(p, initial = false) {
                p.x = Math.random() * this.w;
                p.y = initial ? Math.random() * this.h : -10;
                p.size = Math.random() * 3 + 1;
                p.speed = Math.random() * 1.5 + 0.5;
                p.drift = Math.random() * 0.5 - 0.25;
                return p;
            }
            update() {
                this.particles.forEach(p => {
                    p.y += p.speed;
                    p.x += p.drift;
                    if (p.y > this.h) this.resetParticle(p);
                    if (p.x > this.w) p.x = 0;
                    if (p.x < 0) p.x = this.w;
                });
            }
            draw(ctx) {
                ctx.fillStyle = "rgba(255, 255, 255, 0.6)";
                this.particles.forEach(p => {
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, PI * 2); ctx.fill();
                });
            }
        }

        class Environment {
            constructor(w, h) {
                this.stars = [];
                for (let i = 0; i < 60; i++) this.stars.push({ x: Math.random() * w, y: Math.random() * h * 0.7, blink: Math.random() });
            }
            draw(ctx, w, h) {
                const sky = ctx.createLinearGradient(0, 0, 0, h);
                sky.addColorStop(0, GAME_SETTINGS.colors.bgTop); sky.addColorStop(1, GAME_SETTINGS.colors.bgBottom);
                ctx.fillStyle = sky; ctx.fillRect(0, 0, w, h);
                ctx.fillStyle = "white";
                this.stars.forEach(s => {
                    const opacity = 0.3 + Math.abs(Math.sin(Date.now() * 0.001 + s.blink)) * 0.7;
                    ctx.globalAlpha = opacity; ctx.fillRect(s.x, s.y, 2, 2);
                });
                ctx.globalAlpha = 1.0;
            }
        }

        class Santa {
            constructor() { this.x = 0; this.y = 0; this.anim = 0; this.isWalking = false; this.targetX = 0; }
            draw(ctx) {
                const bounce = this.isWalking ? Math.sin(this.anim) * 5 : 0;
                const x = this.x; const y = this.y + bounce;
                ctx.save();
                // Coat
                ctx.fillStyle = GAME_SETTINGS.colors.santa; ctx.beginPath(); ctx.roundRect(x - 22, y - 50, 44, 45, 12); ctx.fill();
                // Belt
                ctx.fillStyle = 'black'; ctx.fillRect(x - 22, y - 30, 44, 8);
                ctx.fillStyle = '#ffd700'; ctx.fillRect(x - 5, y - 30, 10, 8);
                // Trim
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.roundRect(x - 24, y - 12, 48, 10, 5); ctx.fill();
                // Face
                ctx.fillStyle = '#ffdbac'; ctx.beginPath(); ctx.arc(x, y - 60, 12, 0, PI * 2); ctx.fill();
                // Beard
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(x, y - 55, 18, 0, PI * 2); ctx.fill();
                // Hat
                ctx.fillStyle = GAME_SETTINGS.colors.santa; ctx.beginPath(); ctx.moveTo(x - 15, y - 72); ctx.lineTo(x + 15, y - 72); ctx.lineTo(x, y - 105); ctx.fill();
                // Pom
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(x, y - 105, 5, 0, PI * 2); ctx.fill();
                ctx.restore();
            }
        }

        class GameEngine {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.scoreEl = document.getElementById('score-val');
                this.isGameActive = false;
                this.rafId = null;
                this.loopEpoch = 0;
                this.state = 'INITIAL';
                
                this.handleStart = this.handleStart.bind(this);
                this.handleEnd = this.handleEnd.bind(this);
                this.resize = this.resize.bind(this);
            }

            start() {
                console.log("Starting Game Engine...");
                this.isGameActive = true;
                
                // Ensure UI is reset
                document.getElementById('start-overlay').style.display = 'flex';
                document.getElementById('victory-screen').style.display = 'none';
                
                this.bindEvents();
                
                // Force a resize calculation now that element is likely visible
                this.resize();
                
                this.initGame();
            }

            stop() {
                console.log("Stopping Game Engine...");
                this.isGameActive = false;
                this.unbindEvents();
                if (this.rafId) cancelAnimationFrame(this.rafId);
            }

            bindEvents() {
                window.addEventListener('resize', this.resize);
                const wrapper = document.getElementById('game-wrapper');
                
                // Input Events
                wrapper.addEventListener('mousedown', this.handleStart);
                wrapper.addEventListener('touchstart', this.handleStart, { passive: false });
                wrapper.addEventListener('mouseup', this.handleEnd);
                wrapper.addEventListener('touchend', this.handleEnd, { passive: false });
                
                // UI Buttons
                document.getElementById('entry-button').onclick = (e) => {
                    e.stopPropagation();
                    console.log("Game IDLE, Ready to play");
                    document.getElementById('start-overlay').style.display = 'none';
                    this.state = 'IDLE'; 
                };
                
                document.getElementById('restart-button').onclick = (e) => {
                    e.stopPropagation();
                    document.getElementById('victory-screen').style.display = 'none';
                    this.initGame();
                    this.state = 'IDLE';
                };
            }

            unbindEvents() {
                window.removeEventListener('resize', this.resize);
                const wrapper = document.getElementById('game-wrapper');
                wrapper.removeEventListener('mousedown', this.handleStart);
                wrapper.removeEventListener('touchstart', this.handleStart);
                wrapper.removeEventListener('mouseup', this.handleEnd);
                wrapper.removeEventListener('touchend', this.handleEnd);
            }

            initGame() {
                if (this.rafId) cancelAnimationFrame(this.rafId);
                this.loopEpoch++;
                this.score = 0;
                this.scoreEl.innerText = "0";
                
                // IMPORTANT: Wait for user to click Start button
                this.state = 'WAITING_START'; 
                
                this.sceneX = 0; this.targetSceneX = 0;
                
                // Ensure we have dimensions
                if(this.canvas.width === 0) this.resize();
                
                this.env = new Environment(this.width, this.height);
                this.particles = new ParticleFactory(this.width, this.height);
                this.santa = new Santa();
                
                this.platforms = [{ x: 50, w: 120 }];
                this.sticks = [];
                for (let i = 0; i < 4; i++) this.addPlatform();
                
                const startPlat = this.platforms[0];
                this.santa.x = startPlat.x + startPlat.w - 30;
                this.santa.y = this.height - GAME_SETTINGS.platformHeight;
                
                console.log("Game initialized. Waiting for start...");
                this.loop();
            }

            addPlatform() {
                const last = this.platforms[this.platforms.length - 1];
                const gap = 40 + Math.random() * 200; 
                const w = 50 + Math.random() * 100;
                const x = last.x + last.w + gap;
                this.platforms.push({ x, w });
            }
resize() {
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                this.canvas.width = this.width;
                this.canvas.height = this.height;
                // If game hasn't started or is just initing, place santa correctly
                if(this.santa) {
                     // Check if falling, otherwise keep on ground
                     if(this.state !== 'FALLING') {
                         this.santa.y = this.height - GAME_SETTINGS.platformHeight;
                     }
                }
            }

            update() {
                this.particles.update();
                this.sceneX += (this.targetSceneX - this.sceneX) * 0.1;

                if (this.state === 'GROWING') {
                    const currentStick = this.sticks[this.sticks.length - 1];
                    currentStick.len += GAME_SETTINGS.stickGrowthRate;
                    if (currentStick.len > this.height) currentStick.len = this.height;
                }

                if (this.state === 'TURNING') {
                    const currentStick = this.sticks[this.sticks.length - 1];
                    currentStick.ang += 0.15;
                    if (currentStick.ang >= PI/2) {
                        currentStick.ang = PI/2;
                        this.calculateMoveResult();
                    }
                }

                if (this.state === 'WALKING') {
                    this.santa.isWalking = true;
                    this.santa.anim += 0.2;
                    if (this.santa.x < this.santa.targetX) {
                        this.santa.x += GAME_SETTINGS.santaWalkSpeed;
                        if (this.santa.x > this.santa.targetX) this.santa.x = this.santa.targetX;
                    } else {
                        this.santa.isWalking = false; this.santa.anim = 0;
                        if (this.moveResult === 'SAFE') {
                            this.score++;
                            this.scoreEl.innerText = this.score;
                            if (this.score >= GAME_SETTINGS.winScore) {
                                this.state = 'VICTORY';
                                document.getElementById('victory-screen').style.display = 'flex';
                            } else {
                                this.state = 'TRANSITION';
                                const nextPlat = this.platforms[this.sticks.length];
                                this.targetSceneX = nextPlat.x - 100; 
                            }
                        } else {
                            this.state = 'FALLING';
                        }
                    }
                }

                if (this.state === 'TRANSITION') {
                    if (Math.abs(this.sceneX - this.targetSceneX) < 2) {
                        this.state = 'IDLE';
                        if (this.platforms.length < this.sticks.length + 5) this.addPlatform();
                    }
                }

                if (this.state === 'FALLING') {
                    this.santa.y += 15; this.santa.anim += 0.5;
                    if (this.santa.y > this.height + 200) this.initGame();
                }
            }

            calculateMoveResult() {
                const stick = this.sticks[this.sticks.length - 1];
                const stickTip = stick.x + stick.len;
                const nextPlatIndex = this.sticks.length;
                
                // Should not happen, but safeguard
                if (nextPlatIndex >= this.platforms.length) return; 

                const targetPlat = this.platforms[nextPlatIndex];
                const hit = (stickTip >= targetPlat.x && stickTip <= targetPlat.x + targetPlat.w);

                if (hit) {
                    this.moveResult = 'SAFE';
                    this.santa.targetX = targetPlat.x + targetPlat.w - 30;
                } else {
                    this.moveResult = 'FALL';
                    this.santa.targetX = stickTip;
                }
                this.state = 'WALKING';
            }

            draw() {
                this.ctx.clearRect(0, 0, this.width, this.height);
                this.env.draw(this.ctx, this.width, this.height);
                
                this.ctx.save();
                this.ctx.translate(this.width/2, this.height/2);
                this.ctx.scale(GAME_SETTINGS.fixedScale, GAME_SETTINGS.fixedScale);
                this.ctx.translate(-this.width/2, -this.height/2);
                this.ctx.translate(-this.sceneX, 0);

                this.platforms.forEach(p => {
                    const grad = this.ctx.createLinearGradient(p.x, this.height - GAME_SETTINGS.platformHeight, p.x, this.height);
                    grad.addColorStop(0, GAME_SETTINGS.colors.platform1); grad.addColorStop(1, GAME_SETTINGS.colors.platform2);
this.ctx.fillStyle = grad;
                    this.ctx.beginPath(); this.ctx.roundRect(p.x, this.height - GAME_SETTINGS.platformHeight, p.w, 1000, 15); this.ctx.fill();
                    this.ctx.fillStyle = 'rgba(255,255,255,0.8)'; this.ctx.fillRect(p.x, this.height - GAME_SETTINGS.platformHeight, p.w, 10);
                    this.ctx.fillStyle = GAME_SETTINGS.colors.santa; this.ctx.fillRect(p.x + p.w / 2 - 2, this.height - GAME_SETTINGS.platformHeight, 4, 4);
                });

                this.sticks.forEach(s => {
                    this.ctx.save();
                    this.ctx.translate(s.x, this.height - GAME_SETTINGS.platformHeight);
                    this.ctx.rotate(s.ang);
                    this.ctx.lineWidth = 6; this.ctx.lineCap = "round";
                    this.ctx.strokeStyle = '#d42426'; this.ctx.beginPath(); this.ctx.moveTo(0,0); this.ctx.lineTo(0, -s.len); this.ctx.stroke();
                    this.ctx.setLineDash([8, 8]); this.ctx.strokeStyle = 'white'; this.ctx.beginPath(); this.ctx.moveTo(0,0); this.ctx.lineTo(0, -s.len); this.ctx.stroke();
                    this.ctx.restore();
                });

                this.santa.draw(this.ctx);
                this.ctx.restore();
                this.particles.draw(this.ctx);
            }

            loop() {
                const currentEpoch = this.loopEpoch;
                if (!this.isGameActive) return;

                this.update();
                this.draw();
                
                if (this.loopEpoch !== currentEpoch) return;
                this.rafId = requestAnimationFrame(() => this.loop());
            }

            handleStart(e) {
                // IMPORTANT: Do not grow stick if we are waiting for the Start button click
                if (this.state !== 'IDLE') return;
                
                if(e.type === 'touchstart') e.preventDefault();
                
                const currentPlat = this.platforms[this.sticks.length];
                this.sticks.push({ x: currentPlat.x + currentPlat.w - 5, len: 0, ang: 0 });
                this.state = 'GROWING';
            }

            handleEnd(e) {
                if (this.state !== 'GROWING') return;
                if(e.type === 'touchend') e.preventDefault();
                this.state = 'TURNING';
            }
        }

        /* =========================================
           PART 3: INTEGRATION
           ========================================= */
        
        let gameEngine = null;

        function transitionToGame() {
            console.log("Transitioning to game...");
            // 1. Hide Card Flow
            const app = document.getElementById('app-container');
            app.style.opacity = '0';
            app.style.transform = 'translate(-50%, -50%) scale(0.9)'; 
            
            // 2. Hide HTML Snow 
            document.getElementById('card-snow').style.opacity = '0';
            
            // 3. Change Background to Night
            document.body.style.background = "var(--bg-night)";
            
            setTimeout(() => {
                app.classList.add('hidden');
                
                // 4. Show Game Wrapper
                const gameWrapper = document.getElementById('game-wrapper');
                gameWrapper.classList.remove('hidden');
                
                // Wait a tick for display:block to apply
                setTimeout(() => {
                    gameWrapper.classList.add('active');
                    if(!gameEngine) gameEngine = new GameEngine();
                    gameEngine.start();
                }, 50);
            }, 800);
        }

        function exitGame() {
            if(gameEngine) gameEngine.stop();
            
            const gameWrapper = document.getElementById('game-wrapper');
            gameWrapper.classList.remove('active');
            
            setTimeout(() => {
                gameWrapper.classList.add('hidden');
                
                document.body.style.background = "linear-gradient(180deg, #ffebee 0%, #ffffff 100%)";
                document.getElementById('card-snow').style.opacity = '1';

                const app = document.getElementById('app-container');
                app.classList.remove('hidden');
                
                setTimeout(() => {
                    app.style.opacity = '1';
                    app.style.transform = 'translate(-50%, -50%) scale(1)';
                }, 50);
            }, 800);
        }

        function resetGameLogic() {
            if(gameEngine) {
                gameEngine.initGame();
                gameEngine.state = 'IDLE';
            }
        }

        // Initialize on Load
        window.addEventListener('load', () => {
            console.log("App Loaded");
            createCardSnow();
            // Ensure Card Screen 1 is default
            document.getElementById('screen-1').classList.add('active');
            document.getElementById('screen-1').style.opacity = '1';
        });

    </script>
</body>
</html>